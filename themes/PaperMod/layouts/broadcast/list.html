{{ define "main" }}
<style>
body { background-color:#f5f5f5; color:#222; font-family:sans-serif; }
.broadcast-container { max-width:800px; margin:3rem auto; padding:0 1rem; }
.broadcast-title { text-align:center; font-size:2rem; font-weight:bold; color:#222; margin-bottom:2rem; }
.broadcast-item { background:#fff; border-radius:12px; padding:1.2rem; margin-bottom:1.5rem; box-shadow:0 3px 10px rgba(0,0,0,0.05);}
.broadcast-item h3 { margin:0 0 0.5rem 0; font-size:1.4rem; }
.broadcast-item p { margin:0; font-size:1rem; color:#555; }

/* LOST & FOUND 点击动画 */
#lostfound {
  cursor:pointer; text-align:center; margin:2rem 0; font-style:italic; color:#777; font-size:1.2rem; position:relative; overflow:visible;
}
#lostfound.dissolve { animation: inkSpread 1.4s ease-out forwards; }
@keyframes inkSpread {
  0% { opacity:1; filter:blur(0px); transform:scale(1); letter-spacing:0; }
  40% { opacity:0.9; filter:blur(3px); transform:scale(1.05); }
  70% { opacity:0.45; filter:blur(9px); transform:scale(1.22); }
  100% { opacity:0; filter:blur(15px); transform:scale(1.35); letter-spacing:4px; }
}
/* 简易烟雾效果 */
#smokeCanvas { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; }
</style>

<div class="broadcast-container">
  <div id="lostfound">LOST & FOUND 像水消失在水中
    <canvas id="smokeCanvas" width="260" height="80"></canvas>
  </div>

  <div class="broadcast-list" id="broadcastList">
    <!-- Firebase 数据会渲染在这里 -->
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCcerqGJVSsMwLs7eoRjATE8X7bplWsD54",
    authDomain: "drunk-broadcast.firebaseapp.com",
    projectId: "drunk-broadcast",
    storageBucket: "drunk-broadcast.firebasestorage.app",
    messagingSenderId: "998143016108",
    appId: "1:998143016108:web:87c3a60b853aaf75f27309"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const ref = collection(db, "broadcasts");

// 渲染广播列表
async function loadBroadcasts() {
  const q = query(ref, orderBy("timestamp", "desc"));
  const snapshot = await getDocs(q);
  const list = document.getElementById("broadcastList");
  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.className = "broadcast-item";
    div.innerHTML = `<h3>${data.title}</h3><p>${data.content}</p>`;
    list.appendChild(div);
  });
}
loadBroadcasts();

// 点击动画 + 烟雾
document.getElementById("lostfound").addEventListener("click", function() {
  const el = this;
  el.classList.add("dissolve");
  startSmoke();
  setTimeout(() => { window.location.href="/broadcast/"; }, 1500);
});

function startSmoke() {
  const canvas = document.getElementById("smokeCanvas");
  const ctx = canvas.getContext("2d");
  let particles = [];
  const W = canvas.width;
  const H = canvas.height;
  for(let i=0;i<28;i++){
    particles.push({
      x: W/2 + (Math.random()-0.5)*20,
      y: H/2 + (Math.random()-0.5)*10,
      r: Math.random()*12+6,
      opacity: 0.25+Math.random()*0.2,
      driftX: (Math.random()-0.5)*0.6,
      driftY: (Math.random()-1.2)*0.6,
      fade: Math.random()*0.005+0.003
    });
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{
      ctx.beginPath();
      ctx.fillStyle=`rgba(180,180,180,${p.opacity})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
      p.x+=p.driftX; p.y+=p.driftY; p.opacity-=p.fade; p.r*=1.003;
      if(p.opacity<=0)p.opacity=0;
    });
    requestAnimationFrame(draw);
  }
  draw();
}
</script>
{{ end }}
