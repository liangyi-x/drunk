{{ define "main" }}
<style>
/* 基本布局 */
.broadcast-title {
  text-align: center;
  font-size: 2rem;
  color: #fff;
  margin-top: 2rem;
}

.broadcast-container {
  max-width: 800px;
  margin: 2rem auto;
  padding: 1rem;
  background-color: #888; /* 灰色背景 */
  border-radius: 12px;
  color: #222;
  position: relative;
}

/* LOST & FOUND 墨散雾气动画 */
#lostfound {
  cursor: pointer;
  text-align: center;
  font-size: 1.2rem;
  color: #555;
  position: relative;
  overflow: visible;
  margin-bottom: 2rem;
}

@keyframes inkSpread {
  0% { opacity:1; filter:blur(0); transform:scale(1); letter-spacing:0; }
  40% { opacity:0.9; filter:blur(3px); transform:scale(1.05); }
  70% { opacity:0.45; filter:blur(9px); transform:scale(1.22); }
  100% { opacity:0; filter:blur(15px); transform:scale(1.35); letter-spacing:4px; }
}

#lostfound.dissolve {
  animation: inkSpread 1.4s ease-out forwards;
}

#smokeCanvas {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}
</style>

<div class="broadcast-title">{{ .Title }}</div>

<div id="lostfound">
  {{ .Title }}
  <canvas id="smokeCanvas" width="260" height="80"></canvas>
</div>

<div class="broadcast-container" id="broadcastList">
  <!-- Firebase 广播列表会渲染在这里 -->
</div>

<script>
// LOST & FOUND 点击动画
const lf = document.getElementById("lostfound");
lf.addEventListener("click", () => {
  lf.classList.add("dissolve");
  startSmoke();
  setTimeout(() => { window.location.href = "/drunk/broadcast/"; }, 1500);
});

// 简易烟雾粒子
function startSmoke() {
  const canvas = document.getElementById("smokeCanvas");
  const ctx = canvas.getContext("2d");
  let particles = [];
  const W = canvas.width, H = canvas.height;

  for(let i=0;i<28;i++){
    particles.push({
      x: W/2 + (Math.random()-0.5)*20,
      y: H/2 + (Math.random()-0.5)*10,
      r: Math.random()*12+6,
      opacity: 0.25+Math.random()*0.2,
      driftX: (Math.random()-0.5)*0.6,
      driftY: (Math.random()-1.2)*0.6,
      fade: Math.random()*0.005+0.003
    });
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{
      ctx.beginPath();
      ctx.fillStyle = `rgba(180,180,180,${p.opacity})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      p.x+=p.driftX; p.y+=p.driftY; p.opacity-=p.fade; p.r*=1.003;
      if(p.opacity<=0)p.opacity=0;
    });
    requestAnimationFrame(draw);
  }
  draw();
}

// -----------------
// Firebase 广播列表
// -----------------
/* 请替换成你自己的 Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCcerqGJVSsMwLs7eoRjATE8X7bplWsD54",
  authDomain: "drunk-broadcast.firebaseapp.com",
  projectId: "drunk-broadcast",
  storageBucket: "drunk-broadcast.firebasestorage.app",
  messagingSenderId: "998143016108",
  appId: "1:998143016108:web:87c3a60b853aaf75f27309"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

function renderBroadcasts() {
  const container = document.getElementById("broadcastList");
  db.collection("broadcasts").orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      container.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.style.marginBottom = "1rem";
        div.style.padding = "0.8rem";
        div.style.background = "#eee";
        div.style.borderRadius = "8px";
        div.innerHTML = `<strong>${data.author || "匿名"}</strong>: ${data.content}`;
        container.appendChild(div);
      });
    });
}

renderBroadcasts();
</script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

{{ end }}
