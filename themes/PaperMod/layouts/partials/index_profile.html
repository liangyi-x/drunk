<div class="profile">
  {{- with site.Params.profileMode }}
  <div class="profile_inner">
        {{- if .imageUrl -}}
        {{- $img := "" }}
        {{- if not (urls.Parse .imageUrl).IsAbs }}
            {{- $img = resources.Get .imageUrl }}
        {{- end }}
        {{- if $img }}
            {{- $processableFormats := (slice "jpg" "jpeg" "png" "tif" "bmp" "gif") -}}
            {{- if hugo.IsExtended -}}
                {{- $processableFormats = $processableFormats | append "webp" -}}
            {{- end -}}
            {{- $prod := (hugo.IsProduction | or (eq site.Params.env "production")) }}
            {{- if and (in $processableFormats $img.MediaType.SubType) (eq $prod true)}}
                {{- if (not (and (not .imageHeight) (not .imageWidth))) }}
                    {{- $img = $img.Resize (printf "%dx%d" .imageWidth .imageHeight) }}
                {{- else if .imageHeight }}
                    {{- $img = $img.Resize (printf "x%d" .imageHeight) }}
                {{ else if .imageWidth }}
                    {{- $img = $img.Resize (printf "%dx" .imageWidth) }}
                {{ else }}
                    {{- $img = $img.Resize "150x150" }}
                {{- end }}
            {{- end }}
            <img draggable="false" src="{{ $img.Permalink }}" alt="{{ .imageTitle | default "profile image" }}" title="{{ .imageTitle }}"
                height="{{ .imageHeight | default 150 }}" width="{{ .imageWidth | default 150 }}" />
        {{- else }}
        <img draggable="false" src="{{ .imageUrl | absURL }}" alt="{{ .imageTitle | default "profile image" }}" title="{{ .imageTitle }}"
            height="{{ .imageHeight | default 150 }}" width="{{ .imageWidth | default 150 }}" />
        {{- end }}
        {{- end }}
        <h1>{{ .title | default site.Title | markdownify }}</h1>
        <span>{{ .subtitle | markdownify }}</span>
        {{- partial "social_icons.html" -}}

        {{- with .buttons }}
        <div class="buttons">
            {{- range . }}
            <a class="button" href="{{ trim .url " " }}" rel="noopener" title="{{ .name }}">
                <span class="button-inner">
                    {{ .name }}
                    {{- if (findRE "://" .url) }}&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="14" width="14">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                    {{- end }}
                </span>
            </a>
            {{- end }}
        </div>
        {{- end }}


  <!-- === 广播模块开始 === -->
  {{ if .IsHome }}
  <div id="broadcast-wrapper" style="margin-top:1rem;">
    <div id="broadcasts" style="max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.6); color:white; padding:0.5rem 1rem; border-radius:8px; font-size:0.95rem;"></div>
    <div style="margin-top:0.5rem; display:flex; gap:0.3rem;">
      <input type="text" id="broadcast-input" placeholder="输入广播信息" style="flex:1; padding:0.3rem; border-radius:4px; border:none;">
      <button id="broadcast-send" style="padding:0.3rem 0.5rem; border:none; border-radius:4px; background:#222; color:#fff; cursor:pointer;">发送</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
  import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCcerqGJVSsMwLs7eoRjATE8X7bplWsD54",
    authDomain: "drunk-broadcast.firebaseapp.com",
    projectId: "drunk-broadcast",
    storageBucket: "drunk-broadcast.firebasestorage.app",
    messagingSenderId: "998143016108",
    appId: "1:998143016108:web:87c3a60b853aaf75f27309",
    measurementId: "G-49Z7SPGJJY"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function sendBroadcast(message) {
    if(!message.trim()) return;
    try {
      await addDoc(collection(db, "broadcasts"), { message, timestamp: new Date() });
      document.getElementById('broadcast-input').value = '';
    } catch(e) { console.error("发送失败:", e); }
  }

  document.getElementById("broadcast-send").addEventListener("click", () => sendBroadcast(document.getElementById("broadcast-input").value));
  document.getElementById("broadcast-input").addEventListener("keydown", (e) => { if(e.key==="Enter") sendBroadcast(e.target.value); });

  const broadcastContainer = document.getElementById("broadcasts");
  const q = query(collection(db, "broadcasts"), orderBy("timestamp","desc"));

  onSnapshot(q, (snapshot) => {
    broadcastContainer.innerHTML = "";
    snapshot.forEach(doc => {
      const div = document.createElement("div");
      div.textContent = doc.data().message;
      div.style.marginBottom = "0.3rem";
      broadcastContainer.appendChild(div);
    });
  });
  </script>
  {{ end }}
  <!-- === 广播模块结束 === -->

</div>

    </div>
    {{- end}}
</div>
