<!DOCTYPE html>

<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOST & FOUND</title>
<style>
  body { font-family: "Helvetica Neue", Arial, sans-serif; background:#e0e0e0; margin:0; padding:0; color:#222; }
  h1 { text-align:center; color:white; font-weight:normal; margin-top:2rem; font-size:2rem; }

/* LOST & FOUND 墨散雾气 */
#lostfound { position:relative; text-align:center; margin:2rem auto; cursor:pointer; font-size:1rem; color:#777; }
#smokeCanvas { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); pointer-events:none; width:260px; height:80px; }

@keyframes inkSpread {
0% { opacity:1; filter:blur(0px); transform:scale(1); letter-spacing:0px; }
40% { opacity:0.9; filter:blur(3px); transform:scale(1.05); }
70% { opacity:0.45; filter:blur(9px); transform:scale(1.22); }
100% { opacity:0; filter:blur(15px); transform:scale(1.35); letter-spacing:4px; }
}
.dissolve { animation: inkSpread 1.4s ease-out forwards; }

/* 广播区 */
#broadcast-wrapper { max-width:600px; margin:2rem auto; background:#fff; border-radius:8px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
#broadcasts { max-height:300px; overflow-y:auto; margin-bottom:0.5rem; padding:0.5rem; background:rgba(0,0,0,0.05); border-radius:6px; }
#broadcasts div { margin-bottom:0.4rem; font-size:0.95rem; color:#333; }
#broadcast-input { width:calc(100% - 80px); padding:0.4rem; border-radius:4px; border:1px solid #ccc; }
#broadcast-send { width:70px; padding:0.4rem; border:none; border-radius:4px; background:#222; color:#fff; cursor:pointer; }

</style>
</head>
<body>

<h1>LOST & FOUND</h1>

<div id="lostfound">
  LOST & FOUND
  <canvas id="smokeCanvas"></canvas>
</div>

<div id="broadcast-wrapper">
  <div id="broadcasts">加载中…</div>
  <div style="display:flex; gap:0.3rem;">
    <input type="text" id="broadcast-input" placeholder="输入广播信息">
    <button id="broadcast-send">发送</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";

// Firebase 配置
const firebaseConfig = {
  apiKey: "AIzaSyCcerqGJVSsMwLs7eoRjATE8X7bplWsD54",
  authDomain: "drunk-broadcast.firebaseapp.com",
  projectId: "drunk-broadcast",
  storageBucket: "drunk-broadcast.appspot.com",
  messagingSenderId: "998143016108",
  appId: "1:998143016108:web:87c3a60b853aaf75f27309"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// 匿名登录
signInAnonymously(auth).catch(e => console.error(e));

// 广播集合
const broadcastRef = collection(db,"broadcasts");
const inputEl = document.getElementById("broadcast-input");
const sendBtn = document.getElementById("broadcast-send");
const listEl = document.getElementById("broadcasts");

// 发送广播
sendBtn.addEventListener("click", async ()=>{
  const text=inputEl.value.trim();
  if(!text) return;
  try{ await addDoc(broadcastRef,{message:text,timestamp:new Date()}); inputEl.value=""; }
  catch(e){console.error("发送失败:",e);}
});
inputEl.addEventListener("keydown",e=>{ if(e.key==="Enter") sendBtn.click(); });

// 实时显示
const q = query(broadcastRef, orderBy("timestamp","desc"));
onSnapshot(q, snapshot=>{
  listEl.innerHTML="";
  snapshot.forEach(doc=>{
    const div = document.createElement("div");
    div.textContent = doc.data().message;
    listEl.appendChild(div);
  });
}, error => { listEl.textContent="加载失败"; console.error(error); });

// LOST & FOUND 点击墨散动画 + 雾气
const lostEl = document.getElementById("lostfound");
lostEl.addEventListener("click",()=>{
  lostEl.classList.add("dissolve");
  startSmoke();
  setTimeout(()=>{ window.location.href="/drunk/broadcast/"; }, 1400);
});

// 简易烟雾
function startSmoke() {
  const canvas = document.getElementById("smokeCanvas");
  const ctx = canvas.getContext("2d");
  const W = canvas.width, H = canvas.height;
  let particles = [];
  for(let i=0;i<28;i++){
    particles.push({x:W/2+(Math.random()-0.5)*20, y:H/2+(Math.random()-0.5)*10, r:6+Math.random()*12, opacity:0.25+Math.random()*0.2, driftX:(Math.random()-0.5)*0.6, driftY:(Math.random()-1.2)*0.6, fade:0.003+Math.random()*0.005});
  }
  function draw(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{
      ctx.beginPath();
      ctx.fillStyle=`rgba(180,180,180,${p.opacity})`;
      ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fill();
      p.x+=p.driftX; p.y+=p.driftY; p.opacity-=p.fade; p.r*=1.003;
      if(p.opacity<=0)p.opacity=0;
    });
    requestAnimationFrame(draw);
  }
  draw();
}
</script>

</body>
</html>
